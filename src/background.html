<html>
	<script src="set_background_context.js"></script>
	<script src="Options.js"></script>
	<script>
		function Mark(lastReadMsg, timestamp, ignored) {
			this.lastReadMsg = parseInt(lastReadMsg);
			this.timestamp   = parseInt(timestamp);
			this.ignored     = ignored;
			
			if(isNaN(this.lastReadMsg)) {
				this.lastReadMsg = 0;
			}
		}
		
		Mark.prototype.toString = function() {
			var str = this.lastReadMsg;
			str = Mark._appendValue(str, this.timestamp);
			str = Mark._appendValue(str, this.ignored ? 'ignored' : null);
			str = str.replace(/:+$/, '');
			return str;
		};
		
		Mark.fromObject = function(obj) {
			return new Mark(obj.lastReadMsg, obj.timestamp, obj.ignored);
		};
		
		Mark.fromString = function(str) {
			if(str == null) {
				return new Mark();
			}
		
			var parts = str.split(':');
			var lastReadMsg = parts[0];
			var timestamp   = parts[1];
			var ignored     = parts[2];
			return new Mark(lastReadMsg, timestamp, ignored);
		};
		
		Mark._appendValue = function(str, value) {
			str += ':';
			if(value != null) {
				str += value;
			}
			return str;
		};
		
		
		chrome.extension.onRequest.addListener(
			function(request, sender, sendResponse) {
				switch(request.type) {
					case 'get':
						var value = localStorage[request.topic];
						var response = Mark.fromString(value);
						sendResponse(response);
						break;
						
					case 'set':
						var mark = Mark.fromObject(request);
						if(mark.lastReadMsg == 0  &&  !mark.ignored) {
							delete localStorage[request.topic];
						} else {
							mark.timestamp = Date.now();
							localStorage[request.topic] = mark.toString();
						}
						sendResponse({}); // snub them.
						break;
					
					case 'get_options':
						var options = Options.get(sendResponse);
						break;
					
					case 'set_options':
						/* NOT IMPLEMENTED */
						break;
				}
			});
	</script>
</html>
